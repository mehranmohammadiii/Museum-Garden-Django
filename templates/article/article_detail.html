{% extends "maintemplate.html" %}
{% load static %}
{% block title %}
    باغ فردوس|تاریخچه
{% endblock title %}

{% block content %}

<!-- Dynamic Page Header Banner -->
<div class="page-header" style="background-image: url('{% static "images/slider/" %}{{ article.image_name }}');">
    <div class="container">
        <h1 class="page-title">{{ article.subject }}</h1>
    </div>
</div>

<!-- Main Content Section -->
<div class="container content-section py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Article Meta Info -->
            <div class="text-center text-muted mb-4">
                <p>
                    <strong>نویسندگان:</strong> 
                    {% for author in article.author.all %}
                        {{ author.name }} {{ author.family }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <p>
                    <span><strong>تاریخ انتشار:</strong> {{ article.publication_date }}</span> | 
                    <span><strong>تعداد بازدید:</strong> {{ article.view_number }}</span>

                    <button id="like-btn" data-article-id="{{ article.pk }}" data-url="{% url 'article:like_article_view' pk=article.pk %}">
                        لایک (<span id="like-count">{{ article.likes }}</span>)
                    </button>
                </p>
            </div>
            <hr>

            <!-- Article Full Text -->
            <div class="article-body mt-4">
                {{ article.text|linebreaks }}
            </div>

            <!-- PDF Download Link (optional) -->
            {% if article.pdf_file %}
            <div class="text-center mt-5">
                {% comment %} <a href="{{ article.pdf_file.url }}" class="btn btn-success" download> {% endcomment %}
                <a href="{% static "pdf_file/" %}{{article.pdf_file}}" class="btn btn-success" download>
                    <i class="bi bi-file-earmark-pdf-fill"></i> دانلود فایل PDF مقاله
                </a>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- Article Gallery Section (Add this before the endblock) -->
    {% if gallery_images %}
    <div class="row mt-5">
        <div class="col-12">
            <hr>
            <h3 class="text-center my-4">گالری تصاویر مقاله</h3>
        </div>
        
        <!-- Loop through gallery images -->
        {% comment %} {% for image in article.articlegallery_set.all %} {% endcomment %}
        {% comment %} {% for image in article.gallery_images.all %} {% endcomment %}
        {% for image in gallery_images %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm">
                <!-- We add a link to open the image in a new tab -->
                {% comment %} <a href="{{ image.name.url }}" target="_blank"> {% endcomment %}
                <a href="{% static "images/detailgallery1/" %}{{image.name}}" target="_blank">
                    {% comment %} <img src="{{ image.name.url }}" class="card-img-top" alt="{{ image.name.name }}"> {% endcomment %}
                    <img src="{% static "images/detailgallery1/" %}{{image.name}}" class="card-img-top" alt="{{ image.name.name }}">
                </a>
                {# فرض کرده‌ام نام فیلد تصویر در مدل ArticleGallery هم "name" است #}
            </div>
        </div>
        {% endfor %}

    </div>
    {% endif %}

</div> {# This closes the container div #}
<br>
<br>
<br>
<br>

<script>
    // ۱. پیدا کردن دکمه و عناصر لازم
    const likeBtn = document.getElementById('like-btn');
    const likeCountSpan = document.getElementById('like-count');
    
    // ۲. گوش دادن به رویداد کلیک
    likeBtn.addEventListener('click', function() {
        const articleId = this.dataset.articleId;
        const url = this.dataset.url;
        
        // ۳. گرفتن توکن امنیتی CSRF از کوکی‌ها
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // ۴. ارسال درخواست POST با Fetch API (گارسون به آشپزخانه می‌رود)
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken, // ارسال توکن امنیتی
            },
            // body: JSON.stringify({ 'article_id': articleId }) // اگر داده‌ای برای ارسال داشتیم
        })
        .then(response => response.json()) // ۵. تبدیل پاسخ متنی به JSON
        .then(data => { // ۶. کار با داده‌های برگشتی (گارسون با سینی برگشته)
            if (data.status === 'ok') {
                // ۷. به‌روزرسانی صفحه (قرار دادن نوشیدنی روی میز)
                likeCountSpan.textContent = data.likes_count;
                likeBtn.textContent = 'لایک شد!';
                likeBtn.disabled = true; // غیرفعال کردن دکمه
            }
        })
        .catch(error => console.error('Error:', error)); // مدیریت خطا
    });
</script>

{% endblock content %}


